### **TÀI LIỆU KẾ HOẠCH KỸ THUẬT DỰ ÁN (Phiên bản điều chỉnh)**

**Tên dự án:** Project Hermes: Data Synchronization Gateway
**Ngày:** 23/07/2025
**Người soạn thảo:** Solutions Architect/Principal Engineer
**Người nhận:** Tech Lead

### **1. Tổng quan**

Tài liệu này trình bày kế hoạch kỹ thuật chi tiết để xây dựng một hệ thống đồng bộ dữ liệu tự động, hiệu suất cao và có khả năng chịu lỗi. Hệ thống sẽ đọc dữ liệu từ cơ sở dữ liệu nguồn SQL Server (`DQG`), xử lý và đẩy lên API của đối tác một cách an toàn và có kiểm soát. Kế hoạch này tập trung vào phạm vi trách nhiệm của đội phát triển: từ thiết kế, lập trình đến kiểm thử và đóng gói sản phẩm.

### **2. Đề xuất Kiến trúc Hệ thống**

Kiến trúc được đề xuất là mô hình hướng tác vụ (Task-Driven) sử dụng Celery, phù hợp nhất cho các yêu cầu về xử lý nền, đa luồng và có cơ chế retry.

#### **2.1. Sơ đồ Kiến trúc Hệ thống (Mermaid)**

```mermaid
graph TD
    subgraph "Nguồn Dữ liệu"
        MSSQL[(SQL Server DQG)]
    end

    subgraph "Hệ thống Đồng bộ (Project Hermes - Phạm vi của Team)"
        Scheduler[Celery Beat Scheduler] --> Poller[Polling Service]
        Poller -- "Lấy phiếu (status=0, 2) theo ngày" --> MSSQL
        Poller -- "Đưa task vào hàng đợi" --> Redis([Redis Broker])

        Redis -- "Phân phối task" --> WorkerNhap["Worker Phiếu Nhập"]
        Redis -- "Phân phối task" --> WorkerXuat["Worker Phiếu Xuất"]
        Redis -- "Phân phối task" --> WorkerBan["Worker Hóa Đơn Bán"]

        WorkerNhap -- "Gửi dữ liệu" --> PartnerAPI{Partner API}
        WorkerXuat -- "Gửi dữ liệu" --> PartnerAPI
        WorkerBan -- "Gửi dữ liệu" --> PartnerAPI

        PartnerAPI -- "Phản hồi (Success/Error)" --> WorkerNhap
        PartnerAPI -- "Phản hồi (Success/Error)" --> WorkerXuat
        PartnerAPI -- "Phản hồi (Success/Error)" --> WorkerBan

        WorkerNhap -- "Cập nhật status/mã QG" --> MSSQL
        WorkerXuat -- "Cập nhật status/mã QG" --> MSSQL
        WorkerBan -- "Cập nhật status/mã QG" --> MSSQL

        WorkerNhap -- "Ghi log chi tiết" --> MongoDB[(MongoDB Logs)]
        WorkerXuat -- "Ghi log chi tiết" --> MongoDB
        WorkerBan -- "Ghi log chi tiết" --> MongoDB
    end

    subgraph "Hệ thống Đối tác"
        PartnerAPI
    end
```

#### **2.2. Giải trình Kiến trúc**

*   **Kiến trúc hướng tác vụ với Celery:** Mô hình này tách biệt hoàn toàn việc phát hiện công việc (Polling) và thực thi công việc (Workers). Điều này cho phép hệ thống mở rộng dễ dàng, đồng thời cơ chế retry và hàng đợi của Celery/Redis đảm bảo không có dữ liệu nào bị mất khi có lỗi tạm thời.
*   **Luồng xử lý tuần tự theo ngày:** Một `Scheduler` (Celery Beat) sẽ kích hoạt `Polling Service` chạy định kỳ. Service này sẽ truy vấn các phiếu theo thứ tự ngày tăng dần, đảm bảo tính tuần tự theo yêu cầu nghiệp vụ.
*   **Dịch vụ riêng biệt:** Mỗi loại phiếu (Nhập, Xuất, Bán) sẽ được xử lý bởi một nhóm worker riêng, giúp cô lập lỗi và cho phép tùy chỉnh logic xử lý một cách độc lập.

### **3. Đề xuất Chi tiết về Công nghệ**

*   **Ngôn ngữ:** **Python 3.9+**
*   **Framework:** **FastAPI**
    *   **Lý do:** Sử dụng để tận dụng **Pydantic validation** cho việc xác thực dữ liệu đọc từ DB và payload gửi đi, giúp đảm bảo chất lượng dữ liệu và giảm thiểu lỗi. Chúng ta sẽ không khởi chạy server HTTP.
*   **Cơ sở dữ liệu:**
    *   **Nguồn:** **SQL Server** (kết nối qua `pyodbc`).
    *   **Message Broker:** **Redis** (làm trung gian cho Celery).
    *   **Logging:** **MongoDB** (sử dụng `pymongo` để lưu trữ log chi tiết).
*   **Hàng đợi tác vụ:** **Celery** & **Celery Beat**.
*   **Containerization:** **Docker & Docker Compose**
    *   **Bắt buộc:** Để đảm bảo môi trường phát triển đồng nhất và đóng gói sản phẩm cho team khác triển khai. Docker Compose sẽ được dùng để dựng toàn bộ stack trên máy local.
*   **Quản lý biến môi trường:** **python-dotenv**.

### **4. Quy trình Tích hợp Liên tục (CI)**

Phạm vi của chúng ta bao gồm việc thiết lập một quy trình Tích hợp Liên tục (CI) để đảm bảo chất lượng code trước khi bàn giao.

*   **Quy trình CI (đề xuất dùng GitHub Actions):**
    1.  **Khi tạo Pull Request vào `main`:**
        *   **Kiểm tra chất lượng code:** Tự động chạy `flake8` (kiểm tra style) và `black` (format code).
        *   **Kiểm thử đơn vị (Unit Test):** Tự động chạy `pytest` để thực thi các unit test cho logic nghiệp vụ.
    2.  **Khi merge vào `main`:**
        *   **Đóng gói ứng dụng:** Tự động build các Docker image cho từng service worker và gắn phiên bản (tagging).
        *   **Đẩy lên Registry:** Tự động đẩy các image đã được build lên một registry tập trung (vd: Docker Hub, AWS ECR) để team DevOps có thể lấy về và triển khai.

### **5. Phân rã Công việc & Lộ trình (Roadmap)**

#### **5.1. Phân rã công việc (Work Breakdown)**

*   **Epic 1: Nền tảng & Thiết lập (Foundation & Setup)**
    *   **Story 1.1:** Thiết lập cấu trúc dự án (FastAPI, Celery).
    *   **Story 1.2:** Tạo file `docker-compose.yml` để chạy toàn bộ stack trên local.
    *   **Story 1.3:** Thiết lập các module kết nối tới SQL Server, Redis, và MongoDB.
    *   **Story 1.4:** Xây dựng pipeline Tích hợp Liên tục (CI) cơ bản (Lint, Test, Build Image).

*   **Epic 2: Xử lý Phiếu Nhập (End-to-End Flow)**
    *   **Story 2.1:** Tạo `Polling Service` để lấy các `PhieuNhapHeader` và đẩy task vào Celery.
    *   **Story 2.2:** Tạo `PhieuNhapWorker` nhận task, đọc dữ liệu đầy đủ.
    *   **Story 2.3:** Xây dựng lớp `PartnerAPIClient` để gọi API đối tác.
    *   **Story 2.4:** Tích hợp logic xử lý response và cập nhật trạng thái vào DB.
    *   **Story 2.5:** Tích hợp logic ghi log chi tiết vào MongoDB.
    *   **Story 2.6:** Triển khai cơ chế retry của Celery cho các lỗi mạng.

*   **Epic 3: Mở rộng cho các loại phiếu khác**
    *   **Story 3.1:** Tái cấu trúc và tạo `PhieuXuatWorker`.
    *   **Story 3.2:** Tái cấu trúc và tạo `HoaDonWorker`.
    *   **Story 3.3:** Cập nhật `Polling Service` để lấy cả 3 loại phiếu.

*   **Epic 4: Hoàn thiện & Bàn giao**
    *   **Story 4.1:** Hoàn thiện logic phân loại lỗi (4xx vs 5xx).
    *   **Story 4.2:** Xây dựng các Pydantic model để validate dữ liệu chặt chẽ cho cả 3 loại phiếu.
    *   **Story 4.3:** Viết tài liệu hướng dẫn bàn giao (README.md), mô tả rõ các biến môi trường cần thiết và cách chạy ứng dụng từ Docker image.

#### **5.2. Lộ trình đề xuất**

*   **Tuần 1-2: Giai đoạn Nền tảng.** Hoàn thành **Epic 1**.
*   **Tuần 3-5: Giai đoạn MVP - Luồng đầu tiên.** Hoàn thành **Epic 2**.
*   **Tuần 6-7: Giai đoạn Mở rộng.** Hoàn thành **Epic 3**.
*   **Tuần 8: Giai đoạn Hoàn thiện và Bàn giao.** Hoàn thành **Epic 4**.

### **6. Phân tích Rủi ro & Phương án Giảm thiểu**

| Rủi ro                                                              | Mức độ   | Phương án Giảm thiểu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -                                                                                                                                                           -                               -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    --                               -                                                                                                                            --                               -                               -                                                                                             -                               -                               -                                                                                             -                               -                               -                                                                                             -                               -                               -                               -                                                                                             -                               -                               -                                                                                             -                               -                               -                               -                                                                                             -                                                                                             -                               -                               -                                                                                             -                               -                               -                                                                                             -                               -                               -                                                                                             -                               -                                                                                             -                                                                                             -                                                                                             -                                                                                             -                               -                                                                                             -                                                                                             -                                                                                             -                                                                                             -                                                                                             -                               -.. |
-   **API của đối-tác không ổn định hoặc tài liệu không rõ ràng.**             | Cao      | 1.  **Tích hợp sớm:** Ưu tiên xây dựng luồng end-to-end cho 1 loại phiếu để làm việc với API đối tác càng sớm càng tốt.
2.  **Tạo lớp Client API (Adapter Pattern):** Xây dựng một lớp Python riêng (`partner_api_client.py`) để bao bọc tất cả các logic gọi API.
3.  **Yêu cầu môi trường Sandbox:** Đảm bảo có một môi trường Sandbox ổn định từ đối tác để kiểm thử. |
| **Dữ liệu nguồn không nhất quán hoặc sai định dạng.**                     | Trung bình | 1.  **Validation chặt chẽ:** Sử dụng Pydantic để validate dữ liệu ngay sau khi đọc từ SQL Server. Các phiếu không hợp lệ sẽ được đánh dấu `status = 3` và ghi log rõ ràng.
2.  **Báo cáo lỗi dữ liệu:** Thiết lập cơ chế thông báo về các phiếu bị lỗi do dữ liệu nguồn không hợp lệ. |
| **Mất dữ liệu hoặc cập nhật trạng thái sai khi có lỗi.**                  | Cao      | 1.  **Thiết kế Idempotent Task:** Đảm bảo việc thực thi một task nhiều lần đều cho ra cùng một kết quả. Worker sẽ kiểm tra `status_phieu` trước khi xử lý.
2.  **Logging toàn diện:** Ghi log cẩn thận trước và sau mỗi bước quan trọng (gọi API, cập nhật DB) vào MongoDB để dễ dàng truy vết. |
| **Rủi ro trong phối hợp với team DevOps/Vận hành.**                      | Trung bình | 1.  **Tài liệu bàn giao rõ ràng:** Cung cấp tài liệu `README.md` chi tiết, định nghĩa rõ các biến môi trường cần thiết, cách build và chạy ứng dụng.
2.  **Định nghĩa "Hợp đồng" Docker Image:** Thống nhất với team DevOps về cấu trúc của Docker image mà chúng ta bàn giao. |

### **7. Định nghĩa Hoàn thành (Definition of Done - DoD)**

Một User Story được xem là "Hoàn thành" và sẵn sàng để bàn giao cho team DevOps khi đáp ứng tất cả các tiêu chí sau:

*   Code đã được review và merge vào `main` (có ít nhất 1 thành viên khác approve).
*   Unit test được viết cho các logic nghiệp vụ quan trọng và đạt độ bao phủ > 85%.
*   Pipeline CI (Lint, Test, Build) chạy thành công.
*   Docker image của service đã được build thành công và đẩy lên registry chung.
*   Tài liệu hướng dẫn (README.md) đã được cập nhật với các thay đổi tương ứng (nếu có).
*   Tính năng đã được QA xác nhận là có thể kiểm thử được (dựa trên việc chạy trên môi trường local hoặc được team DevOps triển khai lên Staging).

---

Kế hoạch này giờ đây đã được tinh gọn để phản ánh chính xác phạm vi công việc của đội ngũ chúng ta. Tôi tin rằng nó sẽ giúp team tập trung vào mục tiêu quan trọng nhất: xây dựng một lõi xử lý dữ liệu vững chắc và đáng tin cậy.